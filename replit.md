# U-hub - Telegram Mini App для КНУ

## Огляд проекту
U-hub - це комплексний Telegram Mini App для студентів Київського національного університету імені Тараса Шевченка. Додаток надає функціонал для перегляду новин, управління розкладом занять, завантаження відео та організації студентських подій.

## Останні зміни (14 жовтня 2025)

### Виправлені помилки та покращення:
1. **Персистентність учасників подій** - статус приєднання користувача до події тепер зберігається у файл `eventParticipants.json` і не втрачається при перезапуску сервера
2. **Збереження позицій зображень в адмін-панелі** - позиція зображень (object-position) тепер коректно зберігається в `adminSettings.json`, включаючи крайні значення 0% та 100%
3. **Покращені анімації** - додані плавні переходи, hover ефекти, ripple ефект на кнопках та staggered fadeInUp анімації для карток
4. **Виправлено центрування дати/часу** - дата та час тепер точно центровані по горизонталі
5. **Skeleton loader для зображень** - додано preload функцію та skeleton loader для покращення завантаження зображень без показу тексту до фото

## Основні функції

### 1. Новини (2 сторінки)
- Автоматичний парсинг новин з 5-7 джерел:
  - Офіційний сайт КНУ (international.knu.ua, knu.ua)
  - Telegram канали: @iir_student_council, @spu_knu, @srs_knu, @electionsknu
- Стрічка новин з можливістю перегляду повної інформації
- Функція поширення новин у Telegram

### 2. Розклади занять (4 сторінки)
- Пошук розкладу за кодом спеціальності або назвою
- Фільтр по курсу (1-4 курс)
- Перегляд розкладу на тиждень (Пн-Пт)
- Детальний перегляд розкладу дня з часом, предметами, викладачами та аудиторіями
- Збереження "Мій розклад" (зберігається в localStorage)
- Схеми переміщення по університету

### 3. Відео (1 сторінка)
- Завантаження відео користувачами
- Система модерації (схвалення/відхилення)
- Інтеграція з TikTok каналом для публікації схвалених відео
- Сповіщення користувачів про статус відео

### 4. Події (4 сторінки)
- Створення подій з датою, часом, місцем та описом
- Приєднання до подій з інтеграцією Telegram (аватари, імена користувачів)
- Вихід з подій через кнопку поряд з "Чат"
- Міні-чат для кожної події з відображенням аватарів та імен
- Галерея фото подій
- Автоматичне завершення подій після закінчення терміну дії
- Трекінг учасників через Telegram User ID

### 5. Адмін-панель
- Доступ за паролем "1234" на /admin
- Три основні розділи:
  - **Зображення блоків**: Зміна hero images для Новин, Розкладів, Відео, Івентів
  - **Розсилка**: Масова відправка повідомлень всім користувачам бота
  - **Модерація відео**: Перегляд та модерація відео (схвалення/відхилення)
- Збереження налаштувань в adminSettings.json

## Технічний стек

### Frontend
- HTML5 + Vanilla JavaScript
- Tailwind CSS для стилізації
- Lucide Icons для іконок
- Telegram Web App SDK

### Backend
- Node.js 20
- Express.js (веб-сервер)
- Cheerio (парсинг HTML)
- Axios (HTTP запити)
- ExcelJS (парсинг Excel файлів)
- Multer (завантаження файлів)
- node-telegram-bot-api (Telegram Bot API)

## Структура проекту
```
/
├── public/               # Frontend файли
│   ├── index.html       # Всі 12 сторінок додатку
│   └── app.js           # JavaScript логіка
├── parsers/             # Модулі парсингу
│   ├── newsParser.js    # Парсинг новин
│   └── scheduleParser.js # Парсинг розкладу
├── uploads/             # Завантажені файли
│   ├── videos/          # Відео файли
│   └── photos/          # Фото подій
├── data/                # JSON бази даних
│   ├── events.json      # Події
│   ├── videos.json      # Відео
│   ├── photos.json      # Фото
│   ├── botUsers.json    # Користувачі Telegram бота
│   └── adminSettings.json # Налаштування адмін-панелі
├── server.js            # Головний сервер
├── public/admin.html    # Адмін-панель
└── package.json         # Залежності
```

## API Endpoints

### Новини
- `GET /api/news` - Отримати всі новини

### Розклади
- `GET /api/schedules/search?course=1&query=комунікації` - Пошук розкладу

### Події
- `GET /api/events` - Список всіх подій
- `GET /api/events/:id` - Детальна інформація про подію
- `POST /api/events` - Створити нову подію
- `POST /api/events/:id/join` - Приєднатися до події (з userId, firstName, photoUrl)
- `POST /api/events/:id/leave` - Вийти з події
- `GET /api/events/:id/joined` - Перевірити чи користувач приєднаний
- `GET /api/events/:id/messages` - Повідомлення чату події
- `POST /api/events/:id/messages` - Надіслати повідомлення (з даними користувача)

### Адмін-панель
- `POST /api/admin/login` - Вхід в адмін-панель (пароль: 1234)
- `GET /api/admin/settings` - Отримати налаштування
- `POST /api/admin/settings` - Зберегти налаштування
- `POST /api/admin/broadcast` - Розсилка повідомлень
- `GET /api/admin/videos/pending` - Відео на модерації

### Налаштування
- `GET /api/settings/images` - Отримати hero images для блоків

### Відео
- `POST /api/videos/upload` - Завантажити відео
- `GET /api/videos/pending` - Список відео на модерації
- `POST /api/videos/:id/moderate` - Модерувати відео (схвалити/відхилити)

### Фото
- `POST /api/photos/upload` - Завантажити фото
- `GET /api/photos` - Список всіх фото

## Налаштування

### Змінні середовища
Створіть файл `.env` з наступними змінними:
```
TELEGRAM_BOT_TOKEN=your_bot_token_here
PORT=5000
```

### Telegram Bot
1. Створіть бота через @BotFather в Telegram
2. Отримайте токен бота
3. Додайте токен у змінні середовища
4. Налаштуйте Telegram Mini App в @BotFather

## Запуск проекту
```bash
npm start
```

Сервер запуститься на порту 5000.

## Оновлення новин
Система автоматично оновлює кеш новин:
- При старті сервера
- Кожні 30 хвилин

## Особливості реалізації

### Парсинг новин
- Підтримка HTML сайтів через Cheerio
- Парсинг публічних Telegram каналів
- Кешування для швидкого доступу
- Обробка помилок та fallback контент

### Система подій
- Автоматичне закінчення подій за таймером
- Міні-чат з Telegram інтеграцією (аватари, імена)
- Підрахунок учасників через Telegram User ID
- Можливість приєднання та виходу з подій
- Статуси подій (активна/завершена)

### Модерація відео
- Завантаження відео до 100 МБ
- Статуси: pending, approved, rejected
- Автоматична відправка відео в Telegram бот для модерації
- Інлайн-кнопки в боті для швидкої модерації
- Сповіщення користувачів про рішення

### Telegram Bot функціонал
- Збереження користувачів при /start в botUsers.json
- Відправка відео на модерацію з інлайн-кнопками
- Обробка callback_query для модерації
- Масова розсилка повідомлень через адмін-панель

### Адмін-панель
- Простий вхід за паролем (1234)
- Зміна hero images для всіх блоків головної сторінки
- Розсилка повідомлень всім користувачам бота
- Модерація відео з попереднім переглядом

## Розвиток проекту

### Наступні кроки
1. Інтеграція з реальною базою даних (PostgreSQL)
2. Автоматична публікація відео в TikTok через API
3. Push-сповіщення через Telegram Bot
4. Розширена панель адміністратора
5. Реєстрація користувачів та профілі
6. Аналітика використання

### Відомі обмеження
- Використання in-memory сховища (дані втрачаються при рестарті)
- Відсутність автентифікації користувачів
- Tailwind CDN (для production треба встановити як залежність)
- Обмежений функціонал TikTok (потребує API ключ)

## Розгортання на Ubuntu 24.04

Детальна інструкція по розгортанню на власному сервері знаходиться у файлі `DEPLOY_UBUNTU.md`.

### Швидке розгортання
1. Завантажити файли на сервер
2. Запустити `sudo ./deploy-quick.sh`
3. Налаштувати змінні оточення в `.env`
4. Завантажити Excel розклади в `data/schedules/`

### Конфігураційні файли
- `ecosystem.config.js` - PM2 конфігурація для production
- `nginx-uhub.conf` - Nginx reverse proxy конфігурація
- `deploy-quick.sh` - Автоматичний скрипт розгортання

## Дата створення
13 жовтня 2025 року

## Автор
Розроблено для студентів КНУ імені Тараса Шевченка