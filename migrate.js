#!/usr/bin/env node

/**
 * –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON —Ñ–∞–π–ª–æ–≤ –≤ SQLite –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
 * 
 * –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
 *   node migrate.js
 * 
 * –û–ø—Ü–∏–∏:
 *   --help    –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
 *   --dry-run –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ —Ä–µ–∂–∏–º–µ —Å–∏–º—É–ª—è—Ü–∏–∏ (–±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏)
 * 
 * –ü—Ä–∏–º–µ—Ä—ã:
 *   node migrate.js           # –ü–æ–ª–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è
 *   node migrate.js --dry-run # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–∏
 */

const { migrateAllData } = require("./db")
const path = require("path")

// –ü–∞—Ä—Å–∏–Ω–≥ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
const args = process.argv.slice(2)
const isDryRun = args.includes("--dry-run")
const showHelp = args.includes("--help") || args.includes("-h")

// –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
if (showHelp) {
  console.log(`
üîÑ –°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON –≤ SQLite

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
  node migrate.js [–æ–ø—Ü–∏–∏]

–û–ø—Ü–∏–∏:
  --help, -h    –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É
  --dry-run     –†–µ–∂–∏–º —Å–∏–º—É–ª—è—Ü–∏–∏ (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–∏)

–û–ø–∏—Å–∞–Ω–∏–µ:
  –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ JSON —Ñ–∞–π–ª–æ–≤ –≤ SQLite –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
  –ü–µ—Ä–µ–¥ –º–∏–≥—Ä–∞—Ü–∏–µ–π —Å–æ–∑–¥–∞—é—Ç—Å—è —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –≤—Å–µ—Ö JSON —Ñ–∞–π–ª–æ–≤.
  
  –ú–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ —Å–ª–µ–¥—É—é—â–µ–º –ø–æ—Ä—è–¥–∫–µ:
  1. –°–æ–±—ã—Ç–∏—è, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è, –≤–∏–¥–µ–æ, —Ñ–æ—Ç–æ, —Ñ–æ—Ç–æ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
  2. –£—á–∞—Å—Ç–Ω–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π, —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π
  3. –†–µ–∞–∫—Ü–∏–∏ –Ω–∞ —Ñ–æ—Ç–æ, —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏, –∑–∞—Ä–∞–±–æ—Ç–∫–∏
  4. –ë–∞–ª–∞–Ω—Å—ã Stars, –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –≤—ã–≤–æ–¥
  5. –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–≥—Ä—É–∑–∫–∏, –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –±–ª—é—Ä-—Ñ–æ—Ç–æ
  6. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–¥–º–∏–Ω–∞, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

  –§—É–Ω–∫—Ü–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ —è–≤–ª—è—é—Ç—Å—è –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º–∏ - –∏—Ö –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å
  –ø–æ–≤—Ç–æ—Ä–Ω–æ –±–µ–∑ —Ä–∏—Å–∫–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.

–ü—Ä–∏–º–µ—Ä—ã:
  node migrate.js              # –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é
  node migrate.js --dry-run    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∞–π–ª—ã –±–µ–∑ –º–∏–≥—Ä–∞—Ü–∏–∏

–†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏:
  –í—Å–µ JSON —Ñ–∞–π–ª—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–ø–∏—Ä—É—é—Ç—Å—è –≤:
  data/backup/<timestamp>/

–õ–æ–≥–∏:
  –ü—Ä–æ–≥—Ä–µ—Å—Å –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–≤–æ–¥–∏—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π.
  `)
  process.exit(0)
}

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
async function main() {
  console.log("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó")
  console.log("‚ïë   üîÑ –ú–ò–ì–†–ê–¶–ò–Ø –î–ê–ù–ù–´–• –ò–ó JSON –í SQLITE                    ‚ïë")
  console.log("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù")
  console.log()

  if (isDryRun) {
    console.log("‚ö†Ô∏è  –†–ï–ñ–ò–ú –°–ò–ú–£–õ–Ø–¶–ò–ò (--dry-run)")
    console.log("   –†–µ–∞–ª—å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞")
    console.log()
  }

  const dataDir = path.join(__dirname, "data")

  try {
    if (isDryRun) {
      // –í —Ä–µ–∂–∏–º–µ dry-run –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤
      console.log("[v0] üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è JSON —Ñ–∞–π–ª–æ–≤...")
      
      const fs = require("fs")
      const files = [
        "events.json",
        "schedules.json",
        "videos.json",
        "photos.json",
        "navigationPhotos.json",
        "eventParticipants.json",
        "eventMessages.json",
        "photoReactions.json",
        "photoUnlocks.json",
        "photoEarnings.json",
        "userStarsBalances.json",
        "withdrawalRequests.json",
        "dailyPhotoUploads.json",
        "weeklyBlurPhotos.json",
        "adminSettings.json",
        "userRestrictions.json",
        "userSchedules.json",
        "botUsers.json",
      ]

      let foundFiles = 0
      let totalRecords = 0

      for (const file of files) {
        const filePath = path.join(dataDir, file)
        try {
          const data = fs.readFileSync(filePath, "utf-8")
          const parsed = JSON.parse(data)
          const count = Array.isArray(parsed) ? parsed.length : Object.keys(parsed).length
          console.log(`   ‚úÖ ${file.padEnd(30)} - ${count} –∑–∞–ø–∏—Å–µ–π`)
          foundFiles++
          totalRecords += count
        } catch (err) {
          console.log(`   ‚ùå ${file.padEnd(30)} - –Ω–µ –Ω–∞–π–¥–µ–Ω`)
        }
      }

      console.log()
      console.log(`[v0] üìä –ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: ${foundFiles} –∏–∑ ${files.length}`)
      console.log(`[v0] üìä –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${totalRecords}`)
      console.log()
      console.log("[v0] ‚ÑπÔ∏è  –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–µ–∑ --dry-run –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏")
    } else {
      // –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–µ–∞–ª—å–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é
      console.log("[v0] üöÄ –ù–∞—á–∞–ª–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö...")
      console.log("[v0] üìÇ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–∞–Ω–Ω—ã—Ö:", dataDir)
      console.log()

      const stats = await migrateAllData(dataDir)

      console.log()
      console.log("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó")
      console.log("‚ïë   ‚úÖ –ú–ò–ì–†–ê–¶–ò–Ø –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–ê                          ‚ïë")
      console.log("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù")
      console.log()
      console.log("üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏:")
      console.log("   ‚Ä¢ –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ JSON —Ñ–∞–π–ª–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ data/backup/")
      console.log("   ‚Ä¢ –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ SQLite")
      console.log("   ‚Ä¢ –§—É–Ω–∫—Ü–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã - –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–Ω–æ–≤–∞")
      console.log()
    }
  } catch (error) {
    console.error()
    console.error("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó")
    console.error("‚ïë   ‚ùå –û–®–ò–ë–ö–ê –ú–ò–ì–†–ê–¶–ò–ò                                     ‚ïë")
    console.error("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù")
    console.error()
    console.error("–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:")
    console.error(error)
    console.error()
    console.error("üí° –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:")
    console.error("   1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ–∞–π–ª—ã JSON —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –ø–∞–ø–∫–µ data/")
    console.error("   2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –≤ JSON —Ñ–∞–π–ª–∞—Ö")
    console.error("   3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –∑–∞–ø–∏—Å–∏")
    console.error("   4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π")
    console.error()
    process.exit(1)
  }

  // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î
  const { db } = require("./db")
  db.close((err) => {
    if (err) {
      console.error("[v0] ‚ùå –û—à–∏–±–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ë–î:", err.message)
    } else {
      console.log("[v0] üëã –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫—Ä—ã—Ç–æ")
    }
    process.exit(0)
  })
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
process.on("unhandledRejection", (reason, promise) => {
  console.error()
  console.error("‚ùå –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ Promise:")
  console.error(reason)
  process.exit(1)
})

process.on("uncaughtException", (error) => {
  console.error()
  console.error("‚ùå –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ:")
  console.error(error)
  process.exit(1)
})

// –ó–∞–ø—É—Å–∫
main()
