const sqlite3 = require("sqlite3").verbose()
const path = require("path")

// –°–æ–∑–¥–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –≤ –ø–∞–ø–∫–µ data
const dbPath = path.join(__dirname, "data", "botUsers.db")
const db = new sqlite3.Database(dbPath, (err) => {
  if (err) {
    console.error("[v0] ‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:", err.message)
  } else {
    console.log("[v0] ‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö SQLite:", dbPath)
  }
})

// –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
db.serialize(() => {
  // –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–æ—Ç–∞
  db.run(
    `
    CREATE TABLE IF NOT EXISTS bot_users (
      chat_id INTEGER PRIMARY KEY,
      first_name TEXT,
      last_name TEXT,
      username TEXT,
      joined_at TEXT NOT NULL,
      last_interaction TEXT NOT NULL,
      is_active INTEGER DEFAULT 1
    )
  `,
    (err) => {
      if (err) {
        console.error("[v0] ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã bot_users:", err.message)
      } else {
        console.log("[v0] ‚úÖ –¢–∞–±–ª–∏—Ü–∞ bot_users –≥–æ—Ç–æ–≤–∞")
      }
    },
  )

  // –¢–∞–±–ª–∏—Ü–∞ —Å–æ–±—ã—Ç–∏–π
  db.run(
    `
    CREATE TABLE IF NOT EXISTS events (
      id TEXT PRIMARY KEY,
      title TEXT NOT NULL,
      description TEXT,
      start_date TEXT,
      end_date TEXT,
      location TEXT,
      organizer TEXT,
      status TEXT DEFAULT 'pending',
      approved_at TEXT,
      rejected_at TEXT,
      created_at TEXT NOT NULL,
      participants_count INTEGER DEFAULT 0
    )
  `,
    (err) => {
      if (err) console.error("[v0] ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã events:", err.message)
      else console.log("[v0] ‚úÖ –¢–∞–±–ª–∏—Ü–∞ events –≥–æ—Ç–æ–≤–∞")
    },
  )

  // –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π
  db.run(
    `
    CREATE TABLE IF NOT EXISTS schedules (
      id TEXT PRIMARY KEY,
      name TEXT NOT NULL,
      schedule_data TEXT NOT NULL,
      created_at TEXT NOT NULL
    )
  `,
    (err) => {
      if (err) console.error("[v0] ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã schedules:", err.message)
      else console.log("[v0] ‚úÖ –¢–∞–±–ª–∏—Ü–∞ schedules –≥–æ—Ç–æ–≤–∞")
    },
  )

  // –¢–∞–±–ª–∏—Ü–∞ –≤–∏–¥–µ–æ
  db.run(
    `
    CREATE TABLE IF NOT EXISTS videos (
      id TEXT PRIMARY KEY,
      filename TEXT NOT NULL,
      thumbnail_filename TEXT,
      url TEXT NOT NULL,
      thumbnail_url TEXT,
      description TEXT,
      user_id TEXT,
      first_name TEXT,
      uploaded_at TEXT NOT NULL,
      status TEXT DEFAULT 'pending',
      approved_at TEXT,
      rejected_at TEXT
    )
  `,
    (err) => {
      if (err) console.error("[v0] ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã videos:", err.message)
      else console.log("[v0] ‚úÖ –¢–∞–±–ª–∏—Ü–∞ videos –≥–æ—Ç–æ–≤–∞")
    },
  )

  // –¢–∞–±–ª–∏—Ü–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π
  db.run(
    `
    CREATE TABLE IF NOT EXISTS photos (
      id TEXT PRIMARY KEY,
      filename TEXT NOT NULL,
      url TEXT NOT NULL,
      event_id TEXT,
      description TEXT,
      user_id TEXT,
      first_name TEXT,
      uploaded_at TEXT NOT NULL,
      status TEXT DEFAULT 'pending',
      approved_at TEXT,
      rejected_at TEXT,
      album_id TEXT,
      album_index INTEGER,
      album_total INTEGER,
      unlock_count INTEGER DEFAULT 0,
      has_blur INTEGER DEFAULT 0,
      paid_unlocks INTEGER DEFAULT 0
    )
  `,
    (err) => {
      if (err) console.error("[v0] ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã photos:", err.message)
      else console.log("[v0] ‚úÖ –¢–∞–±–ª–∏—Ü–∞ photos –≥–æ—Ç–æ–≤–∞")
    },
  )

  // –¢–∞–±–ª–∏—Ü–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
  db.run(
    `
    CREATE TABLE IF NOT EXISTS event_participants (
      event_id TEXT NOT NULL,
      user_id TEXT NOT NULL,
      first_name TEXT,
      joined_at TEXT NOT NULL,
      PRIMARY KEY (event_id, user_id)
    )
  `,
    (err) => {
      if (err) console.error("[v0] ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã event_participants:", err.message)
      else console.log("[v0] ‚úÖ –¢–∞–±–ª–∏—Ü–∞ event_participants –≥–æ—Ç–æ–≤–∞")
    },
  )

  // –¢–∞–±–ª–∏—Ü–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å–æ–±—ã—Ç–∏–π
  db.run(
    `
    CREATE TABLE IF NOT EXISTS event_messages (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      event_id TEXT NOT NULL,
      user_id TEXT NOT NULL,
      first_name TEXT,
      message TEXT NOT NULL,
      photo_url TEXT,
      timestamp TEXT NOT NULL
    )
  `,
    (err) => {
      if (err) console.error("[v0] ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã event_messages:", err.message)
      else console.log("[v0] ‚úÖ –¢–∞–±–ª–∏—Ü–∞ event_messages –≥–æ—Ç–æ–≤–∞")
    },
  )

  // –¢–∞–±–ª–∏—Ü–∞ –±–∞–ª–∞–Ω—Å–æ–≤ Stars
  db.run(
    `
    CREATE TABLE IF NOT EXISTS user_stars_balances (
      user_id TEXT PRIMARY KEY,
      balance INTEGER DEFAULT 0,
      updated_at TEXT NOT NULL
    )
  `,
    (err) => {
      if (err) console.error("[v0] ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã user_stars_balances:", err.message)
      else console.log("[v0] ‚úÖ –¢–∞–±–ª–∏—Ü–∞ user_stars_balances –≥–æ—Ç–æ–≤–∞")
    },
  )

  // –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∞–∫—Ü–∏–π –Ω–∞ —Ñ–æ—Ç–æ
  db.run(
    `
    CREATE TABLE IF NOT EXISTS photo_reactions (
      photo_id TEXT NOT NULL,
      user_id TEXT NOT NULL,
      reaction TEXT NOT NULL,
      created_at TEXT NOT NULL,
      PRIMARY KEY (photo_id, user_id)
    )
  `,
    (err) => {
      if (err) console.error("[v0] ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã photo_reactions:", err.message)
      else console.log("[v0] ‚úÖ –¢–∞–±–ª–∏—Ü–∞ photo_reactions –≥–æ—Ç–æ–≤–∞")
    },
  )

  // –¢–∞–±–ª–∏—Ü–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ —Ñ–æ—Ç–æ
  db.run(
    `
    CREATE TABLE IF NOT EXISTS photo_unlocks (
      photo_id TEXT NOT NULL,
      user_id TEXT NOT NULL,
      unlocked_at TEXT NOT NULL,
      PRIMARY KEY (photo_id, user_id)
    )
  `,
    (err) => {
      if (err) console.error("[v0] ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã photo_unlocks:", err.message)
      else console.log("[v0] ‚úÖ –¢–∞–±–ª–∏—Ü–∞ photo_unlocks –≥–æ—Ç–æ–≤–∞")
    },
  )

  // –¢–∞–±–ª–∏—Ü–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫ —Ñ–æ—Ç–æ
  db.run(
    `
    CREATE TABLE IF NOT EXISTS daily_photo_uploads (
      user_date_key TEXT PRIMARY KEY,
      user_id TEXT NOT NULL,
      date TEXT NOT NULL,
      count INTEGER DEFAULT 0
    )
  `,
    (err) => {
      if (err) console.error("[v0] ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã daily_photo_uploads:", err.message)
      else console.log("[v0] ‚úÖ –¢–∞–±–ª–∏—Ü–∞ daily_photo_uploads –≥–æ—Ç–æ–≤–∞")
    },
  )

  // –¢–∞–±–ª–∏—Ü–∞ –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã—Ö –±–ª—é—Ä-—Ñ–æ—Ç–æ
  db.run(
    `
    CREATE TABLE IF NOT EXISTS weekly_blur_photos (
      user_week_key TEXT PRIMARY KEY,
      user_id TEXT NOT NULL,
      week_start TEXT NOT NULL,
      album_id TEXT
    )
  `,
    (err) => {
      if (err) console.error("[v0] ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã weekly_blur_photos:", err.message)
      else console.log("[v0] ‚úÖ –¢–∞–±–ª–∏—Ü–∞ weekly_blur_photos –≥–æ—Ç–æ–≤–∞")
    },
  )

  // –¢–∞–±–ª–∏—Ü–∞ –∑–∞—Ä–∞–±–æ—Ç–∫–æ–≤ –ø–æ —Ñ–æ—Ç–æ
  db.run(
    `
    CREATE TABLE IF NOT EXISTS photo_earnings (
      photo_id TEXT PRIMARY KEY,
      earned INTEGER DEFAULT 0,
      last_payout INTEGER DEFAULT 0
    )
  `,
    (err) => {
      if (err) console.error("[v0] ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã photo_earnings:", err.message)
      else console.log("[v0] ‚úÖ –¢–∞–±–ª–∏—Ü–∞ photo_earnings –≥–æ—Ç–æ–≤–∞")
    },
  )

  // –¢–∞–±–ª–∏—Ü–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –≤—ã–≤–æ–¥
  db.run(
    `
    CREATE TABLE IF NOT EXISTS withdrawal_requests (
      id TEXT PRIMARY KEY,
      user_id TEXT NOT NULL,
      username TEXT,
      amount INTEGER NOT NULL,
      balance INTEGER NOT NULL,
      status TEXT DEFAULT 'pending',
      created_at TEXT NOT NULL,
      processed_at TEXT,
      rejection_reason TEXT
    )
  `,
    (err) => {
      if (err) console.error("[v0] ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã withdrawal_requests:", err.message)
      else console.log("[v0] ‚úÖ –¢–∞–±–ª–∏—Ü–∞ withdrawal_requests –≥–æ—Ç–æ–≤–∞")
    },
  )

  // –¢–∞–±–ª–∏—Ü–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∞–¥–º–∏–Ω–∞
  db.run(
    `
    CREATE TABLE IF NOT EXISTS admin_settings (
      key TEXT PRIMARY KEY,
      value TEXT NOT NULL,
      updated_at TEXT NOT NULL
    )
  `,
    (err) => {
      if (err) console.error("[v0] ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã admin_settings:", err.message)
      else console.log("[v0] ‚úÖ –¢–∞–±–ª–∏—Ü–∞ admin_settings –≥–æ—Ç–æ–≤–∞")
    },
  )

  // –¢–∞–±–ª–∏—Ü–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  db.run(
    `
    CREATE TABLE IF NOT EXISTS user_restrictions (
      user_id TEXT PRIMARY KEY,
      photo_upload_restricted_until TEXT,
      video_upload_restricted_until TEXT,
      chat_restricted_until TEXT
    )
  `,
    (err) => {
      if (err) console.error("[v0] ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã user_restrictions:", err.message)
      else console.log("[v0] ‚úÖ –¢–∞–±–ª–∏—Ü–∞ user_restrictions –≥–æ—Ç–æ–≤–∞")
    },
  )

  // –¢–∞–±–ª–∏—Ü–∞ —Ñ–æ—Ç–æ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
  db.run(
    `
    CREATE TABLE IF NOT EXISTS navigation_photos (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      filename TEXT NOT NULL,
      url TEXT NOT NULL,
      uploaded_at TEXT NOT NULL
    )
  `,
    (err) => {
      if (err) console.error("[v0] ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã navigation_photos:", err.message)
      else console.log("[v0] ‚úÖ –¢–∞–±–ª–∏—Ü–∞ navigation_photos –≥–æ—Ç–æ–≤–∞")
    },
  )

  // –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  db.run(
    `
    CREATE TABLE IF NOT EXISTS user_schedules (
      user_id TEXT PRIMARY KEY,
      schedule_id TEXT NOT NULL,
      assigned_at TEXT NOT NULL
    )
  `,
    (err) => {
      if (err) console.error("[v0] ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã user_schedules:", err.message)
      else console.log("[v0] ‚úÖ –¢–∞–±–ª–∏—Ü–∞ user_schedules –≥–æ—Ç–æ–≤–∞")
    },
  )
})

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function saveUser(chatId, firstName, lastName, username) {
  return new Promise((resolve, reject) => {
    const now = new Date().toISOString()

    db.run(
      `
      INSERT INTO bot_users (chat_id, first_name, last_name, username, joined_at, last_interaction, is_active)
      VALUES (?, ?, ?, ?, ?, ?, 1)
      ON CONFLICT(chat_id) DO UPDATE SET
        first_name = excluded.first_name,
        last_name = excluded.last_name,
        username = excluded.username,
        last_interaction = excluded.last_interaction,
        is_active = 1
    `,
      [chatId, firstName, lastName, username, now, now],
      function (err) {
        if (err) {
          console.error("[v0] ‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", err.message)
          reject(err)
        } else {
          console.log("[v0] ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω/–æ–±–Ω–æ–≤–ª–µ–Ω:", chatId, firstName)
          resolve(this.changes)
        }
      },
    )
  })
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function getAllUsers() {
  return new Promise((resolve, reject) => {
    db.all(
      `
      SELECT chat_id as chatId, first_name as firstName, last_name as lastName, 
             username, joined_at as joinedAt, last_interaction as lastInteraction
      FROM bot_users
      WHERE is_active = 1
      ORDER BY joined_at DESC
    `,
      [],
      (err, rows) => {
        if (err) {
          console.error("[v0] ‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:", err.message)
          reject(err)
        } else {
          console.log("[v0] ‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –ë–î:", rows.length)
          resolve(rows)
        }
      },
    )
  })
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
function getUserCount() {
  return new Promise((resolve, reject) => {
    db.get(
      `
      SELECT COUNT(*) as count
      FROM bot_users
      WHERE is_active = 1
    `,
      [],
      (err, row) => {
        if (err) {
          console.error("[v0] ‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥—Å—á–µ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:", err.message)
          reject(err)
        } else {
          resolve(row.count)
        }
      },
    )
  })
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–º—è–≥–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ)
function deactivateUser(chatId) {
  return new Promise((resolve, reject) => {
    db.run(
      `
      UPDATE bot_users
      SET is_active = 0
      WHERE chat_id = ?
    `,
      [chatId],
      function (err) {
        if (err) {
          console.error("[v0] ‚ùå –û—à–∏–±–∫–∞ –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", err.message)
          reject(err)
        } else {
          console.log("[v0] ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω:", chatId)
          resolve(this.changes)
        }
      },
    )
  })
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ JSON –≤ SQLite
async function migrateFromJSON(jsonUsers) {
  console.log("[v0] üîÑ –ù–∞—á–∞–ª–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ JSON –≤ SQLite...")
  let migrated = 0
  let skipped = 0

  for (const user of jsonUsers) {
    try {
      await saveUser(user.chatId, user.firstName, user.lastName || null, user.username || null)
      migrated++
    } catch (err) {
      console.error("[v0] ‚ùå –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:", user.chatId, err.message)
      skipped++
    }
  }

  console.log("[v0] ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ú–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ:", migrated, "–ü—Ä–æ–ø—É—â–µ–Ω–æ:", skipped)
  return { migrated, skipped }
}

module.exports = {
  db,
  saveUser,
  getAllUsers,
  getUserCount,
  deactivateUser,
  migrateFromJSON,
}
